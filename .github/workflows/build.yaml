---

name: "Build ISO"
run-name: "Build ISO"
on: push

jobs:
  build:
    name: "Build ISO"
    runs-on: ubuntu-latest

    container:
      image: archlinux/archlinux:latest
      options: --privileged

    steps:

      - id: checkout
        name: "Checkout"
        uses: actions/checkout@v5

      - id: install-archiso
        name: "Install ArchISO"
        run: pacman --sync --refresh --sysupgrade --noconfirm --quiet archiso jq

      - id: prepare-custom-profile
        name: "Prepare Custom Profile"
        run: cp --recursive /usr/share/archiso/configs/releng/ archlive

      - id: prepare-installer-config
        name: "Prepare Installer Config"
        run: jq --null-input "${JQ_QUERY}" | tee archlive/airootfs/root/config.json
        env:
          JQ_QUERY: |
            {
              mirror_config: {
                  mirror_regions: {
                      Worldwide: [
                          "http://mirror.rackspace.com/archlinux/$repo/os/$arch",
                          "https://mirror.rackspace.com/archlinux/$repo/os/$arch",
                          "https://ftpmirror.infania.net/mirror/archlinux/$repo/os/$arch",
                          "https://geo.mirror.pkgbuild.com/$repo/os/$arch",
                          "https://fastly.mirror.pkgbuild.com/$repo/os/$arch"
                      ]
                  }
              },
              packages: [
                "base",
                "base-devel",
                "bat",
                "bat-extras",
                "git",
                "git-zsh-completion",
                "github-cli",
                "htop",
                "make",
                "man-db",
                "man-pages",
                "most",
                "posix",
                "posix-c-development",
                "posix-software-development",
                "posix-user-portability",
                "sudo",
                "tar",
                "thefuck",
                "vi",
                "vim",
                "vim-ale",
                "vim-fugitive",
                "vim-gitgutter",
                "vim-molokai",
                "vim-spell-en",
                "vim-spell-eo",
                "vim-syntastic",
                "w3m",
                "wget",
                "wiki-tui",
                "xdg-user-dirs",
                "zsh",
                "zsh-autocomplete",
                "zsh-autosuggestions",
                "zsh-completions",
                "zsh-doc",
                "zsh-history-substring-search",
                "zsh-lovers",
                "zsh-syntax-highlighting"
              ]
            }

      # - id: prepare-installer-script
      #   name: "Prepare Installer Script"
      #   run: .

      - id: prepare-installer-startup
        name: "Prepare Installer Startup"
        run: |
          tee --append archlive/airootfs/root/.zshrc << EOF
          archinstall --script minimal --config config.json
          EOF

      - id: make-iso
        name: "Make ISO"
        run: mkarchiso -v -r archlive

      - id: upload-artifact
        name: "Upload ISO Artifact"
        uses: actions/upload-artifact@v5
        with:
          name: Custom Arch Linux ISO
          path: out/archlinux-*.iso

          # The desired behavior if no files are found using the provided path.
          #
          # Available Options:
          #   warn: Output a warning but do not fail the action
          #   error: Fail the action with an error message
          #   ignore: Do not output any warnings or errors, the action does not fail
          if-no-files-found: error
